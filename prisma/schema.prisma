generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id                    String             @id @default(cuid())
  name                  String
  email                 String             @unique
  phone                 String?
  subscriptionStatus    SubscriptionStatus @default(ACTIVE)
  stripeCustomerId      String?            @unique
  stripeSubscriptionId  String?
  createdAt             DateTime           @default(now())
  updatedAt             DateTime           @updatedAt
  commissionMethod      String             @default("PROGRESSIVE")
  adminNotes            String?
  clonedAt              DateTime?
  clonedFrom            String?
  isClone               Boolean            @default(false)
  lastIssue             String?
  lastIssueDate         DateTime?
  onboardingCompletedAt DateTime?
  subscriptionTier      SubscriptionTier?
  betaAccess            Boolean?           @default(false)
  betaExpiresAt         DateTime?          @db.Timestamptz(6)
  betaPreviousTier      SubscriptionTier?
  timezone              String             @default("Asia/Singapore")
  clients               Client[]
  // Commission v1 (to be removed after migration)
  commissionTiers       CommissionTier[]
  // Commission v2
  commissionProfiles    CommissionProfile[]
  commissionCalculations CommissionCalculation[]
  invitations           Invitation[]
  locations             Location[]
  packageTypes          PackageType[]
  packages              Package[]
  sessions              Session[]
  users                 User[]

  @@index([betaAccess, betaExpiresAt], map: "idx_organizations_beta")
  @@map("organizations")
}

model CommissionProfile {
  id                String   @id @default(cuid())
  organizationId    String
  name              String
  isDefault         Boolean  @default(false)
  isActive          Boolean  @default(true)
  calculationMethod CalculationMethod @default(PROGRESSIVE)
  triggerType       TriggerType @default(SESSION_COUNT)
  
  organization      Organization @relation(fields: [organizationId], references: [id])
  tiers            CommissionTierV2[]
  users            User[]        @relation("UserCommissionProfile")
  calculations     CommissionCalculation[]
  
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt
  
  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("commission_profiles")
}

model CommissionTierV2 {
  id                    String   @id @default(cuid())
  profileId             String
  tierLevel             Int
  
  // Thresholds (which ones apply depends on profile's triggerType)
  sessionThreshold      Int?
  salesThreshold        Float?
  
  // Rewards (all optional - use what you need)
  sessionCommissionPercent Float?   // % of session value
  sessionFlatFee           Float?   // Fixed $ per session
  salesCommissionPercent   Float?   // % of package sales  
  salesFlatFee            Float?   // Fixed $ per package sold
  tierBonus               Float?   // One-time bonus for reaching tier
  
  profile               CommissionProfile @relation(fields: [profileId], references: [id], onDelete: Cascade)
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  @@unique([profileId, tierLevel])
  @@index([profileId])
  @@map("commission_tiers_v2")
}

model CommissionCalculation {
  id                String   @id @default(cuid())
  organizationId    String
  userId            String
  profileId         String?
  periodStart       DateTime
  periodEnd         DateTime
  
  // Calculation method used
  calculationMethod CalculationMethod
  
  // Summary data
  totalSessions     Int
  totalPackagesSold Int?
  
  // Commission breakdown
  sessionCommission Float
  salesCommission   Float?
  tierBonus        Float?
  totalCommission  Float
  
  // Tier information
  tierReached      Int?
  
  // Snapshot of calculation details
  calculationSnapshot Json?
  
  // Metadata
  calculatedAt     DateTime @default(now())
  
  // Relations
  organization     Organization @relation(fields: [organizationId], references: [id])
  user            User @relation(fields: [userId], references: [id])
  profile         CommissionProfile? @relation(fields: [profileId], references: [id])
  
  @@index([userId, periodEnd])
  @@index([organizationId, periodEnd])
  @@map("commission_calculations")
}

model Location {
  id             String         @id @default(cuid())
  name           String         @unique
  active         Boolean        @default(true)
  createdAt      DateTime       @default(now())
  updatedAt      DateTime       @updatedAt
  organizationId String?
  archivedAt     DateTime?
  archivedBy     String?
  clients        Client[]
  organization   Organization?  @relation(fields: [organizationId], references: [id])
  sessions       Session[]
  userAccess     UserLocation[]

  @@index([active])
  @@index([archivedAt])
  @@map("locations")
}

model User {
  id                    String          @id @default(cuid())
  email                 String
  password              String
  name                  String
  role                  Role            @default(TRAINER)
  active                Boolean         @default(true)
  createdAt             DateTime        @default(now())
  updatedAt             DateTime        @updatedAt
  organizationId        String?
  onboardingCompletedAt DateTime?       @map("onboarding_completed_at")
  // Commission v2 fields
  commissionProfileId   String?
  commissionProfile     CommissionProfile? @relation("UserCommissionProfile", fields: [commissionProfileId], references: [id])
  commissionCalculations CommissionCalculation[]
  adminAuditLogs        AdminAuditLog[] @relation("AdminAuditLogs")
  assignedClients       Client[]        @relation("ClientPrimaryTrainer")
  sentInvitations       Invitation[]    @relation("UserInvitations")
  sessions              Session[]
  createdTokens         TempAuthToken[] @relation("TokenAdmin")
  usedTokens            TempAuthToken[] @relation("TokenUser")
  locations             UserLocation[]
  createdPayments       Payment[]       @relation("PaymentCreatedBy")
  organization          Organization?   @relation(fields: [organizationId], references: [id])

  @@unique([email, organizationId])
  @@map("users")
}

model Client {
  id               String        @id @default(cuid())
  name             String
  email            String
  phone            String?
  locationId       String
  primaryTrainerId String?
  active           Boolean       @default(true)
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  organizationId   String?
  isDemo           Boolean       @default(false)
  location         Location      @relation(fields: [locationId], references: [id])
  organization     Organization? @relation(fields: [organizationId], references: [id])
  primaryTrainer   User?         @relation("ClientPrimaryTrainer", fields: [primaryTrainerId], references: [id])
  packages         Package[]
  sessions         Session[]

  @@unique([email, organizationId])
  @@index([organizationId])
  @@map("clients")
}

model Package {
  id                String        @id @default(cuid())
  clientId          String
  packageType       String        @default("Custom")
  name              String
  totalValue        Float
  totalSessions     Int
  remainingSessions Int           @default(0)
  sessionValue      Float
  startDate         DateTime?
  expiresAt         DateTime?
  active            Boolean       @default(true)
  createdAt         DateTime      @default(now())
  updatedAt         DateTime      @updatedAt
  packageTypeId     String?
  organizationId    String?
  isDemo            Boolean       @default(false)
  client            Client        @relation(fields: [clientId], references: [id])
  organization      Organization? @relation(fields: [organizationId], references: [id])
  packageTypeModel  PackageType?  @relation(fields: [packageTypeId], references: [id])
  sessions          Session[]
  payments          Payment[]

  @@index([organizationId])
  @@map("packages")
}

model Payment {
  id          String   @id @default(cuid())
  packageId   String
  amount      Float
  paymentDate DateTime
  notes       String?
  createdAt   DateTime @default(now())
  createdById String?

  package     Package  @relation(fields: [packageId], references: [id], onDelete: Cascade)
  createdBy   User?    @relation("PaymentCreatedBy", fields: [createdById], references: [id])

  @@index([packageId])
  @@index([paymentDate])
  @@map("payments")
}

model Session {
  id               String        @id @default(cuid())
  trainerId        String
  clientId         String
  packageId        String?
  locationId       String
  sessionDate      DateTime
  sessionValue     Float
  validated        Boolean       @default(false)
  validatedAt      DateTime?
  validationToken  String?       @unique
  validationExpiry DateTime?
  notes            String?
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  cancelled        Boolean       @default(false)
  cancelledAt      DateTime?
  organizationId   String?
  isDemo           Boolean       @default(false)
  client           Client        @relation(fields: [clientId], references: [id])
  location         Location      @relation(fields: [locationId], references: [id])
  organization     Organization? @relation(fields: [organizationId], references: [id])
  package          Package?      @relation(fields: [packageId], references: [id])
  trainer          User          @relation(fields: [trainerId], references: [id])

  @@index([trainerId, sessionDate])
  @@index([validationToken])
  @@index([organizationId])
  @@index([organizationId, sessionDate])
  @@map("sessions")
}

model PackageType {
  id              String       @id @default(cuid())
  organizationId  String
  name            String
  defaultSessions Int?
  defaultPrice    Float?
  isActive        Boolean      @default(true)
  sortOrder       Int          @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  organization    Organization @relation(fields: [organizationId], references: [id])
  packages        Package[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("package_types")
}

model CommissionTier {
  id             String        @id @default(cuid())
  minSessions    Int
  maxSessions    Int?
  percentage     Float
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@map("commission_tiers")
}

model EmailLog {
  id           String    @id @default(cuid())
  to           String
  subject      String
  template     String?
  status       String    @default("pending")
  messageId    String?
  sentAt       DateTime?
  error        String?
  metadata     Json?
  responseTime Int?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([messageId])
  @@map("email_logs")
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String
  entityId   String
  oldValue   Json?
  newValue   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

model Invitation {
  id             String           @id @default(cuid())
  email          String
  role           Role             @default(TRAINER)
  organizationId String
  invitedById    String
  status         InvitationStatus @default(PENDING)
  token          String           @unique @default(cuid())
  expiresAt      DateTime
  acceptedAt     DateTime?
  createdAt      DateTime         @default(now())
  updatedAt      DateTime         @updatedAt
  locationIds    String[]         @default([])
  invitedBy      User             @relation("UserInvitations", fields: [invitedById], references: [id])
  organization   Organization     @relation(fields: [organizationId], references: [id])

  @@unique([email, organizationId])
  @@index([token])
  @@index([status])
  @@map("invitations")
}

model AdminAuditLog {
  id           String   @id @default(cuid())
  adminId      String
  action       String
  targetUserId String?
  targetOrgId  String?
  metadata     Json?
  createdAt    DateTime @default(now())
  admin        User     @relation("AdminAuditLogs", fields: [adminId], references: [id])

  @@map("admin_audit_logs")
}

model TempAuthToken {
  id        String    @id @default(cuid())
  token     String    @unique @default(cuid())
  userId    String
  adminId   String
  expiresAt DateTime
  usedAt    DateTime?
  revokedAt DateTime?
  metadata  Json?
  createdAt DateTime  @default(now())
  admin     User      @relation("TokenAdmin", fields: [adminId], references: [id])
  user      User      @relation("TokenUser", fields: [userId], references: [id])

  @@index([token])
  @@index([expiresAt])
  @@map("temp_auth_tokens")
}

model UserLocation {
  id         String   @id @default(cuid())
  userId     String
  locationId String
  createdAt  DateTime @default(now())
  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade)
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, locationId])
  @@index([userId])
  @@index([locationId])
  @@map("user_locations")
}

enum SubscriptionTier {
  FREE
  GROWTH
  SCALE
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
}

enum Role {
  TRAINER
  CLUB_MANAGER
  PT_MANAGER
  ADMIN
  SUPER_ADMIN
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
  CANCELLED
}

enum CalculationMethod {
  PROGRESSIVE
  GRADUATED
  FLAT
}

enum TriggerType {
  NONE
  SESSION_COUNT
  SALES_VOLUME
  EITHER_OR
  BOTH_AND
}
