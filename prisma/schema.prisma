generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Organization {
  id                   String             @id @default(cuid())
  name                 String
  email                String             @unique
  phone                String?
  subscriptionTier     SubscriptionTier   @default(FREE)
  subscriptionStatus   SubscriptionStatus @default(ACTIVE)
  stripeCustomerId     String?            @unique
  stripeSubscriptionId String?
  createdAt            DateTime           @default(now())
  updatedAt            DateTime           @updatedAt
  commissionMethod     String             @default("PROGRESSIVE")
  commissionTiers      CommissionTier[]
  locations            Location[]
  packageTypes         PackageType[]
  users                User[]

  @@map("organizations")
}

model Location {
  id             String        @id @default(cuid())
  name           String        @unique
  active         Boolean       @default(true)
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organizationId String?
  clients        Client[]
  organization   Organization? @relation(fields: [organizationId], references: [id])
  sessions       Session[]
  users          User[]

  @@map("locations")
}

model User {
  id              String        @id @default(cuid())
  email           String        @unique
  password        String
  name            String
  role            Role          @default(TRAINER)
  locationId      String?
  active          Boolean       @default(true)
  createdAt       DateTime      @default(now())
  updatedAt       DateTime      @updatedAt
  organizationId  String?
  assignedClients Client[]      @relation("ClientPrimaryTrainer")
  sessions        Session[]
  location        Location?     @relation(fields: [locationId], references: [id])
  organization    Organization? @relation(fields: [organizationId], references: [id])

  @@map("users")
}

model Client {
  id               String    @id @default(cuid())
  name             String
  email            String    @unique
  phone            String?
  locationId       String
  primaryTrainerId String?
  active           Boolean   @default(true)
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  location         Location  @relation(fields: [locationId], references: [id])
  primaryTrainer   User?     @relation("ClientPrimaryTrainer", fields: [primaryTrainerId], references: [id])
  packages         Package[]
  sessions         Session[]

  @@map("clients")
}

model Package {
  id                String       @id @default(cuid())
  clientId          String
  packageType       String       @default("Custom")
  name              String
  totalValue        Float
  totalSessions     Int
  remainingSessions Int          @default(0)
  sessionValue      Float
  startDate         DateTime?
  expiresAt         DateTime?
  active            Boolean      @default(true)
  createdAt         DateTime     @default(now())
  updatedAt         DateTime     @updatedAt
  packageTypeId     String?
  client            Client       @relation(fields: [clientId], references: [id])
  packageTypeModel  PackageType? @relation(fields: [packageTypeId], references: [id])
  sessions          Session[]

  @@map("packages")
}

model Session {
  id               String    @id @default(cuid())
  trainerId        String
  clientId         String
  packageId        String?
  locationId       String
  sessionDate      DateTime
  sessionValue     Float
  validated        Boolean   @default(false)
  validatedAt      DateTime?
  validationToken  String?   @unique
  validationExpiry DateTime?
  notes            String?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  cancelled        Boolean   @default(false)
  cancelledAt      DateTime?
  client           Client    @relation(fields: [clientId], references: [id])
  location         Location  @relation(fields: [locationId], references: [id])
  package          Package?  @relation(fields: [packageId], references: [id])
  trainer          User      @relation(fields: [trainerId], references: [id])

  @@index([trainerId, sessionDate])
  @@index([validationToken])
  @@map("sessions")
}

model PackageType {
  id              String       @id @default(cuid())
  organizationId  String
  name            String
  defaultSessions Int?
  defaultPrice    Float?
  isActive        Boolean      @default(true)
  sortOrder       Int          @default(0)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  organization    Organization @relation(fields: [organizationId], references: [id])
  packages        Package[]

  @@unique([organizationId, name])
  @@index([organizationId])
  @@map("package_types")
}

model CommissionTier {
  id             String        @id @default(cuid())
  minSessions    Int
  maxSessions    Int?
  percentage     Float
  createdAt      DateTime      @default(now())
  updatedAt      DateTime      @updatedAt
  organizationId String?
  organization   Organization? @relation(fields: [organizationId], references: [id])

  @@map("commission_tiers")
}

model EmailLog {
  id           String    @id @default(cuid())
  to           String
  subject      String
  template     String?
  status       String    @default("pending")
  messageId    String?
  sentAt       DateTime?
  error        String?
  metadata     Json?
  responseTime Int?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  @@index([status])
  @@index([createdAt])
  @@index([messageId])
  @@map("email_logs")
}

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entityType String
  entityId   String
  oldValue   Json?
  newValue   Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([userId])
  @@index([entityType, entityId])
  @@map("audit_logs")
}

enum SubscriptionTier {
  FREE
  GROWTH
  PRO
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  PAST_DUE
}

enum Role {
  TRAINER
  CLUB_MANAGER
  PT_MANAGER
  ADMIN
}
