# Task 09B: Payroll & Exports

**Complexity: 4/10**  
**Priority: ENHANCEMENT (Phase 2)**  
**Status: Not Started**  
**Dependencies: Task 07 (Commission System)**

## Objective
Implement payroll report generation and data export functionality for HR to process commission payments.

## Commission Calculation Methods
**See `/docs/COMMISSION_SYSTEM_DESIGN.md` for complete commission calculation methods and organization-specific configurations.**

## Requirements from PRD
- Monthly payroll report generation
- Export to Excel/CSV format
- Include trainer summaries
- Accurate session counts and values
- HR-friendly format

## Implementation Checklist

### Payroll Report Generation
- [ ] Monthly report generator
- [ ] Include all validated sessions
- [ ] Group by trainer
- [ ] Calculate totals per trainer
- [ ] Add location information
- [ ] Include date range

### Report Data Points
- [ ] Trainer ID and name
- [ ] Email address
- [ ] Location assignment
- [ ] Total sessions completed
- [ ] Total session value
- [ ] Validation rate percentage
- [ ] Period start/end dates
- [ ] Report generation timestamp

### Export Formats
- [ ] Excel (.xlsx) export
- [ ] CSV export
- [ ] PDF summary (optional)
- [ ] Formatted for payroll system
- [ ] Include metadata sheet
- [ ] Add summary totals

### Export Interface
- [ ] Month/year selector
- [ ] Location filter (optional)
- [ ] Preview before export
- [ ] Download button
- [ ] Email delivery option
- [ ] Export history log

### Data Validation
- [ ] Verify all sessions included
- [ ] Check for data anomalies
- [ ] Flag unusual patterns
- [ ] Include validation summary
- [ ] Reconciliation notes

### Scheduled Reports
- [ ] Auto-generate on month end
- [ ] Email to HR team
- [ ] Archive generated reports
- [ ] Retention policy (13 months)
- [ ] Audit trail for exports

### Additional Exports
- [ ] Session detail export
- [ ] Client list export
- [ ] Trainer roster export
- [ ] Package summary export
- [ ] Custom date range exports

## Acceptance Criteria
- [ ] Reports generate accurately
- [ ] Excel format opens correctly
- [ ] All validated sessions included
- [ ] Totals calculate correctly
- [ ] Export completes in <10 seconds
- [ ] Historical reports accessible

## Technical Notes
- Use streaming for large exports
- Implement progress indicator
- Cache generated reports
- Use background job for large exports
- Archive reports to cloud storage

## Excel Report Structure
```
Sheet 1: Summary
- Report Period: December 2024
- Generated: 2024-12-31 23:59
- Total Trainers: 15
- Total Sessions: 450
- Total Value: $45,000

Sheet 2: Trainer Details
Name | Email | Location | Sessions | Value | Rate
-----|-------|----------|----------|-------|------
John | j@gym | Main Gym | 45       | 4500  | 95%
Jane | a@gym | West Loc | 38       | 3800  | 92%

Sheet 3: Metadata
- Report Version: 1.0
- Generated By: System
- Filters Applied: None
```

## CSV Format
```csv
trainer_id,trainer_name,email,location,sessions,total_value,validation_rate,period
123,John Smith,john@gym.com,Main Gym,45,4500.00,95.0,2024-12
124,Jane Doe,jane@gym.com,West Location,38,3800.00,92.0,2024-12
```

## Files to Create/Modify
- `/src/app/api/reports/payroll/route.ts`
- `/src/app/api/reports/export/route.ts`
- `/src/app/reports/payroll/page.tsx`
- `/src/app/reports/page.tsx`
- `/src/lib/reports/payroll-generator.ts`
- `/src/lib/reports/excel-exporter.ts`
- `/src/lib/reports/csv-exporter.ts`
- `/src/components/reports/ExportOptions.tsx`
- `/src/components/reports/ReportPreview.tsx`